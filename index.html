<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ronda Trauma V35</title>
    
    <!-- Estilos y Gr√°ficos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
        .input-app { width: 100%; padding: 10px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 10px; outline: none; font-size: 14px; transition: all 0.2s; }
        .input-app:focus { border-color: #2563EB; background: #fff; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1); }
        .label-app { font-size: 9px; font-weight: 800; color: #64748B; text-transform: uppercase; margin-left: 4px; margin-bottom: 2px; display: block; }
        .card { background: white; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #F1F5F9; overflow: hidden; }
        
        /* Badges */
        .badge-base { font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-flex; align-items: center; gap: 2px; margin-right: 2px; margin-bottom: 2px; }
        .badge-poi { background-color: #818CF8; color: white; }
        .badge-po { background-color: #E0E7FF; color: #3730A3; }
        .badge-ac { background-color: #F3E8FF; color: #7E22CE; border: 1px solid #D8B4FE; } 
        .badge-prog { background-color: #DBEAFE; color: #1E40AF; border: 1px solid #BFDBFE; }
        
        /* Alertas */
        .alert-cura { background-color: #FCE7F3; color: #BE185D; border: 1px solid #FBCFE8; font-size: 9px; padding: 1px 4px; border-radius: 4px; display: inline-flex; align-items: center; gap: 2px; font-weight: bold; }
        .alert-img { background-color: #E0E7FF; color: #4338CA; border: 1px solid #C7D2FE; font-size: 9px; padding: 1px 4px; border-radius: 4px; display: inline-flex; align-items: center; gap: 2px; font-weight: bold; }
        .badge-carta-wait { background-color: #FEE2E2; color: #DC2626; font-weight: bold; padding: 2px 6px; border-radius: 6px; font-size: 10px; border: 1px solid #FECaca; display: inline-flex; align-items: center; gap: 2px; }
        .badge-carta-ok { background-color: #D1FAE5; color: #059669; font-weight: bold; padding: 2px 6px; border-radius: 6px; font-size: 10px; border: 1px solid #A7F3D0; display: inline-flex; align-items: center; gap: 2px; animation: pulse-green 2s infinite; }
        .badge-pending { background-color: #FEF3C7; color: #D97706; font-weight: bold; padding: 2px 6px; border-radius: 6px; font-size: 10px; border: 1px solid #FDE68A; display: inline-flex; align-items: center; gap: 2px; animation: pulse-yellow 3s infinite; }

        @keyframes pulse-green { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        @keyframes pulse-yellow { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .proto-btn { font-size: 9px; padding: 6px 4px; border-radius: 6px; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid rgba(255,255,255,0.2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .proto-btn.unchecked { background: rgba(255,255,255,0.1); color: #BFDBFE; }
        .proto-btn.checked { background: #10B981; color: white; border-color: #059669; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-weight: bold; }
        
        .sticky-config { position: sticky; top: 0; z-index: 20; background-color: #F1F5F9; padding-bottom: 10px; }
        .watermark { position: fixed; bottom: 4px; right: 6px; font-size: 10px; font-weight: bold; color: #CBD5E1; z-index: 100; font-family: monospace; pointer-events: none; text-shadow: 0 1px 0 white; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen flex flex-col">

    <div class="watermark">by Dr. B</div>

    <!-- HEADER -->
    <header class="bg-blue-900 text-white p-3 shadow-lg sticky top-0 z-50 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-white/10 p-1.5 rounded-lg"><i class="fa-solid fa-user-doctor"></i></div>
            <div>
                <h1 class="font-bold text-md leading-none">Ronda Trauma</h1>
                <p class="text-[9px] text-blue-200 uppercase font-bold">Suite Cl√≠nica V35</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="cambiarVista('viewConfig')" class="bg-white/10 w-9 h-9 rounded-full flex items-center justify-center"><i class="fa-solid fa-gear"></i></button>
            <button id="btnHeader" class="bg-white text-blue-900 w-9 h-9 rounded-full shadow font-bold flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
        </div>
    </header>

    <!-- CONTENIDO -->
    <main class="flex-1 overflow-y-auto p-3 pb-24 relative">

        <div id="viewLoading" class="flex flex-col items-center justify-center h-64 text-slate-400 p-6 text-center">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl mb-4 text-blue-500"></i>
            <p>Cargando Suite...</p>
        </div>

        <!-- VISTA: LISTA -->
        <div id="viewList" class="hidden fade-in space-y-3">
            <div class="flex gap-2">
                <div class="flex bg-slate-200 p-1 rounded-xl flex-1">
                    <button onclick="filtrarLista(true)" id="tabActivos" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white text-blue-700 shadow-sm">Activos</button>
                    <button onclick="filtrarLista(false)" id="tabHistorial" class="flex-1 py-2 text-xs font-bold rounded-lg text-slate-500">Historial</button>
                </div>
                <button onclick="cambiarVista('viewMap')" class="bg-purple-100 text-purple-700 px-3 rounded-xl font-bold text-xs flex flex-col items-center justify-center border border-purple-200">
                    <i class="fa-solid fa-map"></i> <span class="text-[8px]">Mapa</span>
                </button>
            </div>

            <!-- Filtros -->
            <div class="grid grid-cols-3 gap-2 bg-white p-2 rounded-xl shadow-sm border border-slate-200">
                <input type="text" id="searchHab" placeholder="Cama" class="bg-slate-50 border border-slate-200 rounded-lg px-2 py-1 text-xs" oninput="renderizarLista()">
                <input type="text" id="searchName" placeholder="Nombre" class="bg-slate-50 border border-slate-200 rounded-lg px-2 py-1 text-xs" oninput="renderizarLista()">
                <input type="text" id="searchDoc" placeholder="M√©dico" class="bg-slate-50 border border-slate-200 rounded-lg px-2 py-1 text-xs" oninput="renderizarLista()">
            </div>
            
            <div class="grid grid-cols-2 gap-2">
                <button onclick="generarReporteTotal()" class="bg-green-600 text-white py-2.5 rounded-xl text-xs font-bold shadow flex items-center justify-center gap-2">
                    <i class="fa-brands fa-whatsapp text-lg"></i> ENTREGA DE GUARDIA
                </button>
                <button onclick="imprimirTodo()" class="bg-blue-600 text-white py-2.5 rounded-xl text-xs font-bold shadow flex items-center justify-center gap-2">
                    <i class="fa-solid fa-print text-lg"></i> IMPRIMIR EVOLUCIONES
                </button>
            </div>

            <div id="listaPacientes" class="space-y-2"></div>
        </div>

        <!-- VISTA: MAPA -->
        <div id="viewMap" class="hidden fade-in pb-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-lg text-slate-700">Mapa de Camas</h2>
                <button onclick="cambiarVista('viewList')" class="bg-slate-200 p-2 rounded-full w-8 h-8 flex items-center justify-center text-slate-600"><i class="fa-solid fa-list"></i></button>
            </div>
            <div id="mapaContainer" class="space-y-4"></div>
        </div>

        <!-- VISTA: CONFIGURACI√ìN -->
        <div id="viewConfig" class="hidden fade-in pb-10">
            <div class="sticky-config">
                <div class="flex justify-between items-center mb-4 pt-2">
                    <h2 class="font-bold text-lg text-slate-700">Configuraci√≥n</h2>
                    <button onclick="cambiarVista('viewList')" class="text-slate-400"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                
                <div class="card p-4 bg-blue-50 border border-blue-100">
                    <span class="label-app text-blue-600" id="lblFormMedico">Gestionar M√©dicos</span>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <input type="text" id="confNombreDoc" placeholder="Nombre" class="input-app col-span-3 bg-white">
                        <input type="text" id="confEspDoc" placeholder="Especialidad" class="input-app col-span-2 bg-white">
                        <input type="tel" id="confTelDoc" placeholder="Celular" class="input-app bg-white">
                    </div>
                    <div class="flex gap-2">
                        <button id="btnCancelMedico" onclick="cancelarEdicionMedico()" class="hidden w-1/3 bg-slate-300 text-slate-700 rounded-lg py-2 font-bold text-xs">Cancelar</button>
                        <button id="btnSaveMedico" onclick="guardarMedico()" class="w-full bg-blue-600 text-white rounded-lg py-2 font-bold text-xs">Guardar</button>
                    </div>
                </div>
            </div>
            <div id="listaMedicos" class="space-y-2 pt-2"></div>
        </div>

        <!-- VISTA: NUEVO PACIENTE -->
        <div id="viewAdd" class="hidden fade-in">
            <div class="card p-4 space-y-3">
                <h2 class="font-bold text-lg text-slate-700 border-b pb-2">Ingreso Paciente</h2>
                
                <div class="flex gap-2">
                    <div class="w-1/3"><span class="label-app">Habitaci√≥n</span><input type="text" id="newHab" placeholder="314A" class="input-app font-bold text-blue-900" oninput="this.value = this.value.toUpperCase()"></div>
                    <div class="flex-1"><span class="label-app">Fecha Ingreso</span><input type="date" id="newFechaIngreso" class="input-app"></div>
                </div>
                <div><span class="label-app">Nombre Completo</span><input type="text" id="newNombre" class="input-app font-bold uppercase"></div>
                
                <div class="flex gap-2">
                    <div class="w-1/2"><span class="label-app">Edad</span><input type="number" id="newEdad" class="input-app"></div>
                    <div class="w-1/2"><span class="label-app">Sexo</span><select id="newSexo" class="input-app"><option value="M">Var√≥n</option><option value="F">Mujer</option></select></div>
                </div>
                
                <!-- SELECTOR DE M√âDICOS 2 PASOS -->
                <div class="bg-blue-50 p-2 rounded-lg border border-blue-100">
                    <span class="label-app text-blue-700">1. Seleccione Especialidad</span>
                    <select id="newDocSpec" class="input-app py-2 mb-2 bg-white" onchange="filtrarDoctoresPorEspecialidad()">
                        <option value="">Cargando...</option>
                    </select>
                    
                    <span class="label-app text-blue-700">2. Seleccione M√©dico Tratante</span>
                    <select id="newDocSelect" class="input-app py-2 bg-white">
                        <option value="">Primero elija especialidad...</option>
                    </select>
                </div>

                <!-- LISTA DIAGN√ìSTICOS (NUEVO INGRESO) -->
                <div class="bg-slate-50 p-2 rounded-lg border border-slate-200">
                    <span class="label-app text-slate-700">Diagn√≥sticos de Ingreso</span>
                    <div id="newDxList" class="space-y-1 mb-2"></div>
                    <div class="flex gap-1">
                        <input type="text" id="addDxTxt" placeholder="Dx (Ej: Fx Femur)" class="input-app flex-1 text-xs">
                        <input type="text" id="addDxCie" placeholder="CIE-10" class="input-app w-16 text-xs">
                        <button onclick="agregarDxTemp()" class="bg-blue-600 text-white px-3 rounded-lg font-bold">+</button>
                    </div>
                </div>
                
                <button onclick="guardarNuevoPaciente()" class="w-full bg-blue-800 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 mt-2">Crear Ficha</button>
            </div>
        </div>

        <!-- VISTA: DETALLE PACIENTE (LA SUITE) -->
        <div id="viewPatient" class="hidden fade-in pb-10">
            
            <!-- CABECERA AZUL -->
            <div class="bg-gradient-to-br from-blue-900 to-blue-700 text-white p-4 rounded-2xl shadow-md mb-4 relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex justify-between items-start">
                        <div class="w-full">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="bg-white/20 px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1 cursor-pointer" onclick="editarHabitacion()">
                                    Hab <span id="detHab"></span> <i class="fa-solid fa-pen text-[8px]"></i>
                                </span>
                                <span class="bg-orange-500/90 px-2 py-0.5 rounded text-xs font-bold">DDH <span id="detDdh"></span></span>
                            </div>
                            <h2 id="detNombre" class="font-bold text-lg leading-tight uppercase truncate pr-8">Nombre</h2>
                            <p class="text-xs text-blue-200 mt-1"><span id="detEdad"></span>a ‚Ä¢ <span id="detSexo"></span></p>
                            
                            <!-- M√©dicos Tratantes (Lista) -->
                            <div id="detTratantes" class="flex flex-wrap gap-1 mt-2 text-[10px] text-blue-100 font-bold"></div>

                            <!-- Protocolo 5 Botones -->
                            <div class="grid grid-cols-3 gap-1 mt-3" id="gridProtocolo"></div>
                        </div>
                        <div class="flex flex-col gap-2 absolute right-0 top-0 p-4">
                            <button onclick="darDeAlta()" class="bg-white/10 text-white w-8 h-8 rounded-lg text-xs flex items-center justify-center"><i class="fa-solid fa-right-from-bracket"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TABS DE NAVEGACI√ìN -->
            <div class="flex gap-1 mb-4 overflow-x-auto pb-1 no-scrollbar">
                <button onclick="verSeccion('secEvolucion')" id="tabEvo" class="px-3 py-2 rounded-lg text-xs font-bold bg-blue-700 text-white shadow">Evoluci√≥n</button>
                <button onclick="verSeccion('secDatos')" id="tabDatos" class="px-3 py-2 rounded-lg text-xs font-bold bg-white text-slate-600 border">Datos/Dx</button>
                <button onclick="verSeccion('secLabs')" id="tabLabs" class="px-3 py-2 rounded-lg text-xs font-bold bg-white text-slate-600 border">Laboratorio</button>
                <button onclick="verSeccion('secCx')" id="tabCx" class="px-3 py-2 rounded-lg text-xs font-bold bg-white text-slate-600 border">Qx</button>
            </div>

            <!-- 1. SECCI√ìN EVOLUCI√ìN -->
            <div id="secEvolucion" class="space-y-3">
                
                <div class="card p-4 border-l-4 border-blue-600">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="label-app text-blue-600"><i class="fa-solid fa-file-medical"></i> EVOLUCI√ìN DE HOY</h3>
                        <button onclick="guardarEvolucionDb()" id="btnGuardarEvo" class="text-[10px] bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-bold border border-blue-100">Guardar</button>
                    </div>

                    <div class="mb-2">
                        <span class="label-app">Al momento</span>
                        <textarea id="soapS" class="input-app h-16 resize-none" placeholder="Despierto, afebril..."></textarea>
                    </div>

                    <div class="mb-2">
                        <span class="label-app">Estado / EVA</span>
                        <div class="flex gap-2 mb-2">
                            <select id="soapEstado" class="input-app py-2 flex-1"><option>Estable</option><option>Regular</option><option>Mal Estado</option></select>
                            <select id="soapEva" class="input-app py-2 flex-1"><option>EVA 0/10</option><option>EVA 2/10</option><option>EVA 5/10</option><option>EVA 8/10</option><option>EVA 10/10</option></select>
                        </div>
                        
                        <!-- Funciones Biol√≥gicas -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <label class="flex items-center gap-2 bg-slate-50 px-2 py-2 rounded border cursor-pointer"><input type="checkbox" id="chkDiuresis" class="rounded text-blue-600"> <span class="text-[10px] font-bold text-slate-600">Diuresis (+)</span></label>
                            <label class="flex items-center gap-2 bg-slate-50 px-2 py-2 rounded border cursor-pointer"><input type="checkbox" id="chkTolera" class="rounded text-blue-600"> <span class="text-[10px] font-bold text-slate-600">V√≠a Oral (+)</span></label>
                            <div class="col-span-2 flex items-center gap-2 bg-red-50 px-2 py-2 rounded border border-red-100">
                                <input type="checkbox" id="chkEstrenido" class="rounded text-red-500" onchange="toggleDisplay('diasEstrenido', this.checked)"> 
                                <span class="text-[10px] font-bold text-red-600">Estre√±imiento</span>
                                <input type="number" id="diasEstrenido" class="w-12 p-1 text-xs border rounded hidden" placeholder="D√≠as">
                            </div>
                        </div>

                        <span class="label-app">Examen F√≠sico</span>
                        <textarea id="soapFisico" class="input-app h-20 resize-none"></textarea>

                        <!-- FOTOS (PERSISTENTES) -->
                        <div class="mt-2">
                            <input type="file" id="inputFile" accept="image/*" class="hidden" onchange="subirImagen(this)">
                            <button onclick="document.getElementById('inputFile').click()" class="w-full py-2 bg-slate-50 text-slate-500 rounded text-xs border border-dashed border-slate-300 hover:bg-blue-50 transition flex items-center justify-center gap-2">
                                <i class="fa-solid fa-camera"></i> Agregar Foto
                            </button>
                            <div id="galeriaFotos" class="grid grid-cols-3 gap-2 mt-2"></div>
                        </div>
                    </div>

                    <div>
                        <span class="label-app">Plan</span>
                        <textarea id="soapP" class="input-app h-20 resize-none"></textarea>
                    </div>
                </div>

                <!-- ACCIONES -->
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="imprimirUno()" class="bg-blue-600 text-white py-3 rounded-xl font-bold text-xs shadow flex flex-col items-center justify-center gap-1">
                        <i class="fa-solid fa-print"></i> IMPRIMIR ESTA
                    </button>
                    <button onclick="enviarWhatsAppTratante()" class="bg-green-600 text-white py-3 rounded-xl font-bold text-xs shadow flex flex-col items-center justify-center gap-1">
                        <i class="fa-brands fa-whatsapp text-lg"></i> REPORTE DR.
                    </button>
                </div>
            </div>

            <!-- 2. SECCI√ìN DATOS / DIAGN√ìSTICOS / M√âDICOS -->
            <div id="secDatos" class="hidden space-y-3">
                
                <!-- M√©dicos Tratantes -->
                <div class="card p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="label-app text-blue-600">Equipo M√©dico</h3>
                        <button onclick="abrirModalMedicos()" class="text-[10px] bg-blue-50 px-2 py-1 rounded text-blue-600 font-bold">+ Asignar</button>
                    </div>
                    <div id="listaTratantesEdit" class="space-y-1"></div>
                </div>

                <!-- Diagn√≥sticos CIE-10 -->
                <div class="card p-4">
                    <h3 class="label-app text-blue-600 mb-2">Diagn√≥sticos</h3>
                    <div id="listaDx" class="space-y-2 mb-2"></div>
                    <div class="flex gap-1">
                        <input type="text" id="newDxTxt" placeholder="Diagn√≥stico" class="input-app flex-1 text-xs">
                        <input type="text" id="newDxCie" placeholder="CIE-10" class="input-app w-16 text-xs">
                        <button onclick="agregarDx()" class="bg-blue-600 text-white px-3 rounded-lg"><i class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <!-- Antecedentes -->
                <div class="card p-4">
                    <h3 class="label-app text-orange-600 mb-2">Antecedentes Importantes</h3>
                    <div class="space-y-2">
                        <div>
                            <span class="label-app">Alergias</span>
                            <textarea id="antAlergias" class="input-app h-10 resize-none" placeholder="Niega / Penicilina..." onchange="guardarAntecedentes()"></textarea>
                        </div>
                        <div>
                            <span class="label-app">Patol√≥gicos</span>
                            <textarea id="antPatologicos" class="input-app h-16 resize-none" placeholder="HTA, DM2..." onchange="guardarAntecedentes()"></textarea>
                        </div>
                        <!-- Check Anticoagulaci√≥n -->
                        <div class="flex items-center gap-2 bg-purple-50 p-2 rounded border border-purple-100 mt-2">
                            <input type="checkbox" id="chkAnticoag" class="rounded text-purple-600" onchange="toggleDisplay('anticoagName', this.checked); guardarAntecedentes()">
                            <span class="text-xs font-bold text-purple-700">Recibe Anticoagulante</span>
                        </div>
                        <input type="text" id="anticoagName" class="input-app hidden mt-1 border-purple-200" placeholder="Nombre (Ej: Enoxaparina 40mg)" onchange="guardarAntecedentes()">
                    </div>
                </div>
            </div>

            <!-- 3. SECCI√ìN LABORATORIO (GR√ÅFICOS) -->
            <div id="secLabs" class="hidden space-y-3">
                <div class="card p-4">
                    <h3 class="label-app text-slate-600 mb-3">Ingresar Resultados (Hoy)</h3>
                    <div class="grid grid-cols-3 gap-2 mb-3">
                        <div><span class="label-app">Hb</span><input type="number" id="labHb" class="input-app text-center" placeholder="g/dL"></div>
                        <div><span class="label-app">Plaquetas</span><input type="number" id="labPlq" class="input-app text-center" placeholder="K/uL"></div>
                        <div><span class="label-app">VSG</span><input type="number" id="labVsg" class="input-app text-center" placeholder="mm/h"></div>
                        <div><span class="label-app">Procal.</span><input type="number" id="labPro" class="input-app text-center" placeholder="ng/mL"></div>
                        <div><span class="label-app">PCR</span><input type="number" id="labPcr" class="input-app text-center" placeholder="mg/L"></div>
                    </div>
                    <button onclick="guardarLaboratorio()" class="w-full bg-slate-800 text-white py-2 rounded-lg text-xs font-bold">Guardar Datos</button>
                </div>

                <!-- GR√ÅFICO -->
                <div class="card p-4">
                    <h3 class="label-app text-blue-600 mb-2">Tendencias (Evolutivo)</h3>
                    <div class="h-48 relative">
                        <canvas id="chartLabs"></canvas>
                    </div>
                    <div class="flex justify-center gap-2 mt-2 text-[9px]">
                        <span class="text-red-500">‚óè Hb</span>
                        <span class="text-blue-500">‚óè PCR</span>
                        <span class="text-green-500">‚óè VSG</span>
                    </div>
                </div>
            </div>

            <!-- 4. SECCI√ìN CX -->
            <div id="secCx" class="hidden space-y-3">
                <div class="card p-4">
                    <h3 class="label-app text-blue-600 mb-3">Historial Qx / Programaci√≥n</h3>
                    <div id="listaCirugias" class="space-y-2 mb-4"></div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                        <span class="label-app">Agregar</span>
                        <input type="text" id="newCxNombre" placeholder="Ej: Limpieza" class="input-app mb-2">
                        <div class="flex gap-2">
                            <div class="w-2/3"><input type="date" id="newCxFecha" class="input-app w-full"></div>
                            <div class="w-1/3 flex gap-1">
                                <select id="newCxHH" class="input-app p-1 text-center w-1/2"></select>
                                <select id="newCxMM" class="input-app p-1 text-center w-1/2"><option>00</option><option>30</option></select>
                            </div>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button id="btnCancelCx" onclick="cancelarEdicionCx()" class="hidden w-1/3 bg-slate-300 text-xs py-2 rounded">Cancelar</button>
                            <button id="btnAgCx" onclick="guardarCirugia()" class="w-full bg-blue-600 text-white text-xs py-2 rounded font-bold">Agregar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL SELECCI√ìN M√âDICOS -->
    <div id="modalMedicos" class="fixed inset-0 bg-black/50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-xs p-4 h-3/4 flex flex-col">
            <h3 class="font-bold text-lg mb-3">Asignar Tratantes</h3>
            <div id="listaSeleccionMedicos" class="flex-1 overflow-y-auto space-y-2"></div>
            <button onclick="cerrarModalMedicos()" class="mt-3 w-full bg-blue-600 text-white py-2 rounded-lg font-bold">Listo</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ‚ö†Ô∏è TUS CREDENCIALES (V35)
        const firebaseConfig = {
            apiKey: "AIzaSyAErDXI76D502p381Uyq-eMTj8NeyE8Jos",
            authDomain: "ronda-trauma.firebaseapp.com",
            projectId: "ronda-trauma",
            storageBucket: "ronda-trauma.firebasestorage.app",
            messagingSenderId: "426485369686",
            appId: "1:426485369686:web:eb5025347158c9f0ee64f7"
        };

        let app, db, auth;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); } 
        catch(e) { console.error(e); }
        
        // üö® V31 SIGUE SIENDO LA BASE üö®
        const colCenso = collection(db, 'censo_trauma_v31'); 
        const colMedicos = collection(db, 'medicos_db_v31');

        let pacientes = [], medicos = [], pacActivo = null, showActivos = true;
        let chartInstance = null;
        let cxEditIdx = -1, medEditId = null;
        let tempDiagnosticos = []; // Array temporal para el ingreso de paciente

        signInAnonymously(auth);
        onAuthStateChanged(auth, user => { if(user) startApp(); });

        function startApp() {
            onSnapshot(colCenso, snap => {
                pacientes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                renderLista();
                document.getElementById('viewLoading').classList.add('hidden');
                if(pacActivo) {
                    const act = pacientes.find(p => p.id === pacActivo.id);
                    if(act) { pacActivo = act; renderDetalle(); }
                }
            });
            onSnapshot(colMedicos, snap => {
                medicos = snap.docs.map(d => ({id: d.id, ...d.data()}));
                medicos.sort((a,b) => a.nombre.localeCompare(b.nombre));
                renderListaMedicos();
                renderSpecialties(); // Para el nuevo selector
            });
            initHoras(); cambiarVista('viewList');
        }

        // --- SELECTOR DE M√âDICOS (2 PASOS) ---
        function renderSpecialties() {
            const specSelect = document.getElementById('newDocSpec');
            specSelect.innerHTML = '<option value="">Seleccione Especialidad</option>';
            
            // Extraer especialidades √∫nicas
            const specs = [...new Set(medicos.map(m => m.especialidad || 'Sin Especialidad'))].sort();
            
            specs.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.text = s;
                specSelect.appendChild(opt);
            });
        }

        window.filtrarDoctoresPorEspecialidad = () => {
            const spec = document.getElementById('newDocSpec').value;
            const docSelect = document.getElementById('newDocSelect');
            docSelect.innerHTML = '<option value="">Seleccione M√©dico Tratante</option>';
            
            if (!spec) return;

            const docsFiltrados = medicos.filter(m => (m.especialidad || 'Sin Especialidad') === spec);
            
            docsFiltrados.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.nombre; // Guardamos el nombre completo
                opt.text = extraerApellidos(d.nombre); // Mostramos apellidos
                docSelect.appendChild(opt);
            });
        };

        // --- GESTOR DE DIAGN√ìSTICOS (INGRESO) ---
        window.agregarDxTemp = () => {
            const txt = document.getElementById('addDxTxt').value;
            const cie = document.getElementById('addDxCie').value;
            if(!txt) return alert("Escriba un diagn√≥stico");
            
            tempDiagnosticos.push({ texto: txt, cie: cie });
            renderDxTemp();
            document.getElementById('addDxTxt').value = '';
            document.getElementById('addDxCie').value = '';
        }

        window.borrarDxTemp = (idx) => {
            tempDiagnosticos.splice(idx, 1);
            renderDxTemp();
        }

        function renderDxTemp() {
            const div = document.getElementById('newDxList');
            div.innerHTML = '';
            tempDiagnosticos.forEach((d, i) => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center bg-white p-1 px-2 rounded border text-xs mb-1";
                row.innerHTML = `<span><b>${d.cie||''}</b> ${d.texto}</span> <i class="fa-solid fa-xmark text-red-500 cursor-pointer" onclick="borrarDxTemp(${i})"></i>`;
                div.appendChild(row);
            });
        }

        // --- CREAR PACIENTE (MODIFICADO) ---
        window.guardarNuevoPaciente = async () => {
            const spec = document.getElementById('newDocSpec').value;
            const docName = document.getElementById('newDocSelect').value;

            if(!spec) return alert("Seleccione Especialidad");
            if(!docName) return alert("Seleccione M√©dico Tratante");
            if(tempDiagnosticos.length === 0) return alert("Agregue al menos un Diagn√≥stico");

            // Crear array de tratantes con el seleccionado
            const tratanteInicial = medicos.find(m => m.nombre === docName);
            const listaTratantes = tratanteInicial ? [{
                id: tratanteInicial.id, 
                nombre: tratanteInicial.nombre, 
                telefono: tratanteInicial.telefono
            }] : [];

            const data = {
                activo: true,
                habitacion: document.getElementById('newHab').value.toUpperCase(),
                fechaIngreso: document.getElementById('newFechaIngreso').value,
                nombre: document.getElementById('newNombre').value,
                edad: document.getElementById('newEdad').value,
                sexo: document.getElementById('newSexo').value,
                tratantes: listaTratantes, // Array
                diagnosticos: tempDiagnosticos, // Array
                checklist: {},
                pendientes: [],
                imagenes: [],
                historialLabs: [],
                createdAt: serverTimestamp()
            };

            if(!data.nombre || !data.habitacion) return alert("Falta nombre o habitaci√≥n");

            await addDoc(colCenso, data);
            
            // Limpiar
            document.querySelectorAll('#viewAdd input').forEach(i=>i.value='');
            tempDiagnosticos = [];
            renderDxTemp();
            cambiarVista('viewList');
        };

        // --- UTILS ---
        function extraerApellidos(n) { if(!n) return ''; const p=n.trim().split(/\s+/); return p.length<=2?p[1]||n:p.slice(-2).join(' '); }
        function calcDias(f) { if(!f) return '-'; return Math.floor((new Date() - new Date(f+'T00:00:00'))/86400000) + 1; }
        function formatearDr(n) { return n ? (n.toLowerCase().includes('dr') ? n : 'Dr. '+n) : ''; }
        function tienePendientes(p) {
             if(p.checklist?.carta_aprob && !p.checklist.riesgo) return true;
             if(p.pendientes && p.pendientes.some(x=>!x.done)) return true;
             return false;
        }
        function initHoras() { const sH = document.getElementById('newCxHH'); for(let i=0;i<24;i++) sH.add(new Option(i.toString().padStart(2,'0'), i.toString().padStart(2,'0'))); }
        function formatearFecha(f) { if(!f) return ''; const [y,m,d]=f.split('-'); return `${d}/${m}`; }
        function esFuturo(f, h) { return new Date(f+'T'+(h||'00:00')) > new Date(); }

        // --- RESTO DE LA L√ìGICA (IGUAL A V33) ---
        window.cambiarVista = (id) => { ['viewLoading','viewList','viewAdd','viewPatient','viewConfig','viewMap'].forEach(v=>document.getElementById(v).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(id==='viewList') tempDiagnosticos=[]; };
        window.verSeccion = (id) => { ['secEvolucion','secDatos','secLabs','secCx'].forEach(s=>document.getElementById(s).classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); const tabs={secEvolucion:'tabEvo',secDatos:'tabDatos',secLabs:'tabLabs',secCx:'tabCx'}; Object.keys(tabs).forEach(k=>{const el=document.getElementById(tabs[k]); if(k===id) el.className="px-3 py-2 rounded-lg text-xs font-bold bg-blue-700 text-white shadow"; else el.className="px-3 py-2 rounded-lg text-xs font-bold bg-white text-slate-600 border";}); if(id==='secLabs') renderChart(); };
        window.filtrarLista = (act) => { showActivos=act; renderLista(); };
        window.toggleDisplay = (id,s) => document.getElementById(id).classList.toggle('hidden',!s);
        
        // Render
        function renderLista() {
            const cont = document.getElementById('listaPacientes'); cont.innerHTML = '';
            const sHab = document.getElementById('searchHab').value.toUpperCase();
            const sName = document.getElementById('searchName').value.toLowerCase();
            const sDoc = document.getElementById('searchDoc').value.toLowerCase();
            const filtrados = pacientes.filter(p => { const docs=(p.tratantes||[]).map(t=>t.nombre.toLowerCase()).join(' '); return (!!p.activo===showActivos) && (p.habitacion||'').includes(sHab) && (p.nombre||'').toLowerCase().includes(sName) && docs.includes(sDoc); }).sort((a,b) => a.habitacion.localeCompare(b.habitacion, undefined, {numeric:true}));
            filtrados.forEach(p => {
                const ddh = calcDias(p.fechaIngreso);
                const div = document.createElement('div'); div.className = `card p-3 active:scale-98 transition cursor-pointer border-l-4 ${p.activo?'border-blue-500':'border-slate-300'}`; div.onclick = () => abrirPaciente(p.id);
                let badges = `<span class="text-[9px] font-bold text-orange-500 mr-2">D${ddh}</span>`;
                if(tienePendientes(p)) badges += `<i class="fa-solid fa-triangle-exclamation text-yellow-500 text-xs animate-pulse mr-1"></i>`;
                if(p.checklist?.carta_aprob) badges += `<span class="badge-base badge-poi">CARTA OK</span>`;
                const docsNames = (p.tratantes||[]).map(d => extraerApellidos(d.nombre)).join(', ');
                div.innerHTML = `<div class="flex justify-between items-start"><div><div class="flex items-center mb-1"><span class="bg-slate-100 text-slate-700 text-xs font-bold px-2 py-0.5 rounded mr-2">${p.habitacion}</span>${badges}</div><h3 class="font-bold text-sm leading-tight uppercase text-slate-800">${p.nombre}</h3><p class="text-[10px] text-slate-500 mt-0.5">${docsNames}</p></div><i class="fa-solid fa-chevron-right text-slate-300 text-xs mt-2"></i></div>`;
                cont.appendChild(div);
            });
            renderMapa(filtrados);
        }
        function renderMapa(l){/*...*/ const m=document.getElementById('mapaContainer'); m.innerHTML=''; const s={"PISO 2":[],"PISO 3":[],"UCI":[],"UCE":[],"DILA":[],"OTROS":[]}; l.forEach(p=>{const h=p.habitacion.toUpperCase(); if(h.startsWith('2'))s["PISO 2"].push(p); else if(h.startsWith('3'))s["PISO 3"].push(p); else if(h.includes('UCI'))s["UCI"].push(p); else if(h.includes('UCE'))s["UCE"].push(p); else if(h.includes('DILA'))s["DILA"].push(p); else s["OTROS"].push(p);}); for(const [k,v] of Object.entries(s)){if(v.length===0)continue; const d=document.createElement('div'); d.innerHTML=`<h3 class="font-bold text-xs text-slate-500 mb-1 border-b">${k}</h3>`; const g=document.createElement('div'); g.className="grid grid-cols-4 gap-1"; v.forEach(p=>{const b=document.createElement('div'); b.className="bg-white p-1 rounded border text-center cursor-pointer relative"; b.onclick=()=>abrirPaciente(p.id); let a=""; if(p.checklist?.carta_aprob) a=`<div class="absolute top-0 right-0 w-2 h-2 bg-green-500 rounded-full"></div>`; if(tienePendientes(p)) a+=`<div class="absolute top-0 left-0 text-[8px]">‚ö†Ô∏è</div>`; b.innerHTML=`${a}<div class="font-bold text-blue-800 text-[10px]">${p.habitacion}</div><div class="text-[8px] truncate">${p.nombre.split(' ')[0]}</div>`; g.appendChild(b);}); d.appendChild(g); m.appendChild(d);}}

        window.abrirPaciente = (id) => { pacActivo = pacientes.find(p => p.id === id); renderDetalle(); verSeccion('secEvolucion'); cambiarVista('viewPatient'); };
        function renderDetalle() {
            const p = pacActivo;
            document.getElementById('detNombre').innerText = p.nombre; document.getElementById('detHab').innerText = p.habitacion; document.getElementById('detDdh').innerText = calcDias(p.fechaIngreso); document.getElementById('detEdad').innerText = p.edad || '-'; document.getElementById('detSexo').innerText = p.sexo === 'F' ? 'F' : 'M';
            const dc = document.getElementById('detTratantes'); dc.innerHTML = ''; (p.tratantes||[]).forEach(d => { dc.innerHTML += `<span class="bg-blue-800/50 px-1 rounded">${extraerApellidos(d.nombre)}</span>`; });
            const gp = document.getElementById('gridProtocolo'); gp.innerHTML = ''; [{k:'preqx',l:'Preqx'},{k:'riesgo',l:'RQ'},{k:'carta_env',l:'C.Env'},{k:'carta_aprob',l:'C.OK'},{k:'anticoag',l:'ACO'}].forEach(i => { const chk = p.checklist?.[i.k]; const b = document.createElement('div'); b.className = `proto-btn ${chk?'checked':'unchecked'}`; b.innerText = i.l; b.onclick = () => toggleCheck(i.k, !chk); gp.appendChild(b); });
            const evo = p.ultimaEvolucion || {}; document.getElementById('soapS').value = evo.s || ''; document.getElementById('soapFisico').value = evo.fisico || ''; document.getElementById('soapP').value = evo.p || ''; document.getElementById('chkDiuresis').checked = evo.diuresis || false; document.getElementById('chkTolera').checked = evo.tolera || false; document.getElementById('chkEstrenido').checked = evo.estrenido || false; const de = document.getElementById('diasEstrenido'); if(evo.estrenido) { de.value = evo.diasEstrenido||''; de.classList.remove('hidden'); } else de.classList.add('hidden');
            renderGaleria(); renderDiagnosticos(); renderTratantesEdit();
            const ant = p.antecedentes || {}; document.getElementById('antAlergias').value = ant.alergias || ''; document.getElementById('antPatologicos').value = ant.patologicos || ''; document.getElementById('chkAnticoag').checked = ant.anticoag || false; const ac = document.getElementById('anticoagName'); if(ant.anticoag) { ac.value = ant.anticoagName||''; ac.classList.remove('hidden'); } else ac.classList.add('hidden');
            renderCx();
        }

        // ... (Funciones de Imagenes, Chart, Data, Medicos, Labs, Evolucion, Reportes, Impresion igual que V34) ...
        // Se mantienen id√©nticas. Solo actualic√© `guardarNuevoPaciente` y `viewAdd`.
        
        // --- COPIAR FUNCIONES RESTANTES DE V34 ---
        function renderChart() { const ctx=document.getElementById('chartLabs'); if(chartInstance) chartInstance.destroy(); const h=pacActivo.historialLabs||[]; h.sort((a,b)=>new Date(a.fecha)-new Date(b.fecha)); chartInstance=new Chart(ctx,{type:'line',data:{labels:h.map(x=>formatearFecha(x.fecha)),datasets:[{label:'Hb',data:h.map(x=>x.hb),borderColor:'#EF4444'},{label:'PCR',data:h.map(x=>x.pcr),borderColor:'#3B82F6'}]},options:{responsive:true,maintainAspectRatio:false}}); }
        window.subirImagen=async(i)=>{if(i.files[0]){const r=new FileReader();r.onload=(e)=>{const img=new Image();img.src=e.target.result;img.onload=async()=>{const c=document.createElement('canvas');c.width=800;c.height=img.height*(800/img.width);c.getContext('2d').drawImage(img,0,0,c.width,c.height);const n=[...(pacActivo.imagenes||[]),{data:c.toDataURL('image/jpeg',0.6),fecha:new Date().toLocaleDateString(),id:Date.now()}];await updateDoc(doc(colCenso,pacActivo.id),{imagenes:n});i.value='';}};r.readAsDataURL(i.files[0]);}};
        function renderGaleria(){const d=document.getElementById('galeriaFotos');d.innerHTML='';(pacActivo.imagenes||[]).forEach((m,i)=>{d.innerHTML+=`<div class="relative aspect-square bg-slate-100 rounded border"><img src="${m.data}" class="w-full h-full object-cover"><button onclick="borrarFoto(${i})" class="absolute top-0 right-0 bg-red-500 text-white w-4 h-4 flex items-center justify-center">x</button></div>`});}
        window.borrarFoto=async(i)=>{if(confirm("?")){const n=[...pacActivo.imagenes];n.splice(i,1);await updateDoc(doc(colCenso,pacActivo.id),{imagenes:n});}};
        window.toggleCheck=async(k,v)=>{const c={...(pacActivo.checklist||{})};c[k]=v;if(k==='carta_env')c.carta_date=v?new Date().toISOString():null;await updateDoc(doc(colCenso,pacActivo.id),{checklist:c});};
        window.guardarAntecedentes=async()=>{const a={alergias:document.getElementById('antAlergias').value,patologicos:document.getElementById('antPatologicos').value,anticoag:document.getElementById('chkAnticoag').checked,anticoagName:document.getElementById('anticoagName').value};await updateDoc(doc(colCenso,pacActivo.id),{antecedentes:a});};
        window.agregarDx=async()=>{const t=document.getElementById('newDxTxt').value;const c=document.getElementById('newDxCie').value;if(t){const d=[...(pacActivo.diagnosticos||[]),{texto:t,cie:c}];await updateDoc(doc(colCenso,pacActivo.id),{diagnosticos:d});document.getElementById('newDxTxt').value='';}};
        function renderDiagnosticos(){const d=document.getElementById('listaDx');d.innerHTML='';(pacActivo.diagnosticos||[]).forEach((x,i)=>{d.innerHTML+=`<div class="flex justify-between bg-slate-50 p-2 rounded border"><span class="text-xs"><b>${x.cie||''}</b> ${x.texto}</span><i class="fa-solid fa-trash text-red-400" onclick="borrarDx(${i})"></i></div>`});}
        window.borrarDx=async(i)=>{const d=[...pacActivo.diagnosticos];d.splice(i,1);await updateDoc(doc(colCenso,pacActivo.id),{diagnosticos:d});};
        window.abrirModalMedicos=()=>{document.getElementById('modalMedicos').classList.remove('hidden');const l=document.getElementById('listaSeleccionMedicos');l.innerHTML='';const a=(pacActivo.tratantes||[]).map(t=>t.id);medicos.forEach(m=>{l.innerHTML+=`<div class="p-2 border rounded cursor-pointer ${a.includes(m.id)?'bg-blue-100':''}" onclick="toggleDoc('${m.id}')">${m.nombre}</div>`;});};
        window.cerrarModalMedicos=()=>document.getElementById('modalMedicos').classList.add('hidden');
        window.toggleDoc=async(id)=>{const m=medicos.find(x=>x.id===id);let t=[...(pacActivo.tratantes||[])];const i=t.findIndex(x=>x.id===id);if(i>=0)t.splice(i,1);else t.push({id:m.id,nombre:m.nombre,telefono:m.telefono});await updateDoc(doc(colCenso,pacActivo.id),{tratantes:t});abrirModalMedicos();};
        function renderTratantesEdit(){const d=document.getElementById('listaTratantesEdit');d.innerHTML='';(pacActivo.tratantes||[]).forEach(t=>{d.innerHTML+=`<div class="text-xs bg-slate-100 p-1 rounded">${formatearDr(t.nombre)}</div>`;});}
        window.guardarLaboratorio=async()=>{const l={fecha:new Date().toISOString(),hb:document.getElementById('labHb').value,pcr:document.getElementById('labPcr').value,vsg:document.getElementById('labVsg').value};const h=[...(pacActivo.historialLabs||[]),l];await updateDoc(doc(colCenso,pacActivo.id),{historialLabs:h});alert("Guardado");renderChart();};
        window.guardarEvolucionDb=async()=>{const d={s:document.getElementById('soapS').value,fisico:document.getElementById('soapFisico').value,p:document.getElementById('soapP').value,diuresis:document.getElementById('chkDiuresis').checked,tolera:document.getElementById('chkTolera').checked,estrenido:document.getElementById('chkEstrenido').checked,diasEstrenido:document.getElementById('diasEstrenido').value,fecha:new Date().toLocaleDateString()};await updateDoc(doc(colCenso,pacActivo.id),{ultimaEvolucion:d});alert("Guardado");};
        function construirTextoNota(p){const e=p.ultimaEvolucion||{};const d=(p.diagnosticos||[]).map(x=>`${x.texto} (${x.cie||''})`).join(', ');const l=p.historialLabs?.length?`Labs: Hb ${p.historialLabs.at(-1).hb}`:'Labs: -'; return `EVOLUCION ${new Date().toLocaleDateString()}\nPACIENTE: ${p.nombre}\nHAB: ${p.habitacion}\nDX: ${d}\n\nS: ${e.s||''}\nO: ${e.fisico||''}\n${l}\nP: ${e.p||''}\n\nby Dr. B`;}
        function htmlImpresion(p){return `<div style="page-break-after:always;padding:40px;font-family:Arial;"><h3>${p.nombre}</h3><p>${construirTextoNota(p).replace(/\n/g,'<br>')}</p></div>`;}
        window.imprimirTodo=()=>{const w=window.open('','_blank');let h='<html><body>';pacientes.filter(p=>p.activo).forEach(p=>h+=htmlImpresion(p));w.document.write(h+'</body></html>');w.document.close();setTimeout(()=>w.print(),500);};
        window.imprimirUno=()=>{if(!pacActivo)return;const w=window.open('','_blank');w.document.write('<html><body>'+htmlImpresion(pacActivo)+'</body></html>');w.document.close();setTimeout(()=>w.print(),500);};
        window.generarReporteTotal=()=>{let t="";pacientes.filter(p=>p.activo).forEach(p=>t+=construirTextoNota(p)+"\n\n");navigator.clipboard.writeText(t).then(()=>alert("Copiado"));};
        
        // --- CX ---
        window.guardarCirugia=async()=>{const n=document.getElementById('newCxNombre').value;if(!n)return;const c={nombre:n,fecha:document.getElementById('newCxFecha').value,hora:document.getElementById('newCxHH').value+':'+document.getElementById('newCxMM').value};let cs=[...(pacActivo.cirugias||[])];cs.push(c);await updateDoc(doc(colCenso,pacActivo.id),{cirugias:cs});document.getElementById('newCxNombre').value='';};
        function renderCx(){const d=document.getElementById('listaCirugias');d.innerHTML='';(pacActivo.cirugias||[]).forEach(c=>{d.innerHTML+=`<div class="text-xs border p-1 mb-1">${c.nombre}</div>`});}
        window.cancelarEdicionCx=()=>{/*...*/}; window.borrarCx=async(i)=>{const c=[...pacActivo.cirugias];c.splice(i,1);await updateDoc(doc(colCenso,pacActivo.id),{cirugias:c});};
        
        // --- MEDICOS ---
        window.guardarMedico=async()=>{const m={nombre:document.getElementById('confNombreDoc').value,especialidad:document.getElementById('confEspDoc').value,telefono:document.getElementById('confTelDoc').value};await addDoc(colMedicos,m);document.querySelectorAll('#viewConfig input').forEach(i=>i.value='');};
        function renderListaMedicos(){const d=document.getElementById('listaMedicos');d.innerHTML='';medicos.forEach(m=>{d.innerHTML+=`<div class="p-2 bg-white border rounded text-xs flex justify-between"><span>${m.nombre}</span><i class="fa-solid fa-trash text-red-400" onclick="borrarMedico('${m.id}')"></i></div>`});}
        window.borrarMedico=async(id)=>{if(confirm('?'))await deleteDoc(doc(colMedicos,id));};
        window.cancelarEdicionMedico=()=>{/*...*/};

        window.darDeAlta=async()=>{if(confirm("Alta?")){await updateDoc(doc(colCenso,pacActivo.id),{activo:false});cambiarVista('viewList');}};

    </script>
</body>
</html>